最高原则：核心设计

底层系统与数据：

* 世界地图
* 时间系统
* 优奈人物背景与框架
* NPC与魔物数据
* 组织派别数据
* 衣物与装备数据

中层系统：

* 城市治安度
* 欲望值系统
* 堕落值系统
* 金钱系统
* 开发度系统
* 衣物与装备系统
* 生理期系统

上层系统

* 状态系统
* 怀孕系统
* 战斗系统（简易）
* 耐性系统

顶层系统

* 评价系统
* 成就系统
* 固定事件系统
* 剧情系统（简易）

# 🗺️ 系统逻辑分层与调用拓扑图 (System Logic Topology) v2.1

> **定位**：介于“设计圣经”与“程序代码”之间的**逻辑蓝图**。
> **核心原则**：**状态唯一 (Single Source of Truth)**、**单向流动 (Unidirectional Flow)**、**摘要驱动 (Digest Driven)**。
> **目标**：任何系统都知道自己**能读什么、能写什么、不能碰什么**，从源头避免循环依赖与重复计算。

------

## 🛑 层级 0：最高原则 (L0 - The Meta)

> **定义**：不运行逻辑，只定义**不变量**与**权限公约**。

### 0.1 核心设计圣经（不变量）

- 时间粒度：`Day / TimeSlot`
- 关键字段命名：`HP/MP/TP`、`Lust`（欲望）、`Corruption`（堕落/侵蚀）
- 回合循环：**Input → Resolve → Apply → Tick → Digest → Narrate**
- 公式形态约定：例如“费洛蒙=基础值+衣物修正+体液修正”（只规定结构，不写死数值）

### 0.2 权限公约（写入通道统一）

- ✅ **唯一真相只在 L2**：所有持久变化最终都体现在 L2 的字段变化上。
- ✅ **单向流动**：上层可以读下层，但**任何系统不得反向依赖“上层模块”**（只能依赖数据/状态/摘要）。
- ✅ **统一写入通道（Apply）**：
  - L3/L4 只能“提出变更”（结果/结算/影响），**不得直接手改 L2 字段**。
  - 任何变更都必须通过**同一条写入通道**进入 L2，确保可存档、可回放、可测试。
- ✅ **LLM 权限**：LLM 只能产出叙事与选择倾向；**不得决定数值增减**（数值只由 L3/L4 规则与写入通道产生）。

------

## 📚 层级 1：静态数据库 (L1 - Static Database)

> **性质**：**只读 (Read-Only)**。游戏启动时加载的模板/表格（JSON/Markdown/脚本表）。

1. **世界地理 (World Map)**：区域节点、连通性、设施类型（如：`Type: SafeHouse`）。
2. **生物图鉴 (Bestiary)**：魔物/NPC 的基础面板、技能表、AI 行为偏好、掉落表。
3. **物品全书 (Item Registry)**：衣物属性、道具效果、标签索引（如：`#透明`, `#拘束`）。
4. **技能与特质 (Skill & Trait Library)**：招式公式定义、被动特质效果、称号/成就的**定义**（仅定义，不记录是否解锁）。
5. **组织派别数据 (Factions)**：派系关系矩阵、声望等级阈值、派系事件索引。

**[边界]**

- **【读】** 任何层级都可读取。
- **【写】** **禁止**（运行时不改；热更属于“版本补丁”，不属于运行逻辑）。

------

## 💾 层级 2：世界状态层 (L2 - The Truth)

> **性质**：**唯一真相 (The State)**。可序列化、可存档、可回放的状态对象。
> **注意**：L2 只保存“不可或缺的真实状态”，**不保存可完全推导的派生值**（避免不同步）。

### 2.1 状态域划分（示例）

1. **时空域**：`Day`, `TimeSlot`, `LocationID`, `Weather?`（可选）。
2. **角色域**：`HP`, `MP`, `TP`, `Lust`, `Corruption`。
3. **身体域（持久）**：
   - `Fluids`: `{ mouth, womb, skin, ... }`（基础量/残留量，作为真相）
   - `BodyDev`: `{ parts: { chest: { level, exp }, ... } }`
   - `Pregnancy`: `{ stage, countdown, ... }`（若启用怀孕系统）
4. **物资域**：
   - `Wardrobe`: 装备槽位实例（含 `durability`）
   - `Inventory`: 背包
   - `Wallet`: `{ money, debt }`
5. **社会域**：
   - `Reputation`: 各派系声望
   - `GPA`
   - `Flags`: 剧情开关/一次性标记
6. **元数据域（Meta，可选）**：
   - `UnlockedAchievements[]`（已解锁成就ID）
   - `Titles[]`（已获得称号ID）
   - `HistorySnippets[]`（关键历史记录，可选）

### 2.2 明确“不放进 L2 的东西”

- `CurrentPheromone`、`DangerLevel`、`ShopOpen` 这类**可由 L1+L2 推导**的值，默认不入 L2。
  - 若将来为了性能做缓存，也必须标注为：**“可丢弃缓存，不作为判定依据，每回合必重算”**。

**[边界]**

- **【读】** L3, L4, L5 以及 Digest 层。
- **【写】** 只能通过统一写入通道（Apply）落地；L3/L4 不得直改字段。

------

## 🧮 层级 3：规则演算层 (L3 - Simulation Rules)

> **性质**：自动化后台结算 (Tick)。随时间推进的规则，不依赖玩家“当下选择”。
> **输入**：L1 + L2
> **输出**：本回合/本时段产生的“变更集合”（交给 Apply 写入 L2）

### 3.1 建议的 Tick 模块

1. **时间推进器 (Time Engine)**
   - 推进 `Day/TimeSlot`
   - 触发本时段的其他 Tick 执行顺序
2. **生理循环 (Bio-Cycle)**
   - 周期阶段推进、阶段性基础波动（如排卵期基础欲望修正）
3. **城市治安 / 宏观秩序 (Order & Society Tick)**
   - 治安度自然衰减、巡逻强度刷新、区域风险基底变化
4. **经济结算 (Economy Tick)**
   - 债务利息、日常固定支出/收入、黑市/商店规则刷新（仅写“基础驱动量”）
5. **欲望/堕落自然演化 (Lust & Corruption Drift)**
   - 自然回落/上涨、跨阈值时打阶段标记（阶段标记写入 L2 真相）

**[边界]**

- **【读】** L1, L2
- **【写】** 不直写 L2，只产出“变更集合”→交给 Apply

------

## 🎮 层级 4：交互解析层 (L4 - Interaction Resolver)

> **性质**：玩家/剧情入口 (Action)。处理“发生了什么”，并结算结果。
> **输入**：玩家动作 + L1 + L2 + Digest
> **输出**：变更集合（交给 Apply 写入 L2）+ 事件结果摘要（供叙事使用）

### 4.1 L4-A 行为解析器 (Action Handlers)

1. **换装与物品使用 (Wardrobe & Item Use)**
   - 执行 `Equip/Unequip/Use/Repair` 等动作
   - 只修改装备实例/背包/耐久等真相字段
2. **探索与移动 (Exploration & Move)**
   - 执行 `Move/Explore`
   - 依据 Digest 的“风险/可触发池”决定是否触发 EventID
3. **战斗系统（简易）(Combat)**
   - 执行战斗指令，结算 HP/MP/TP/异常/掉落/装备损耗/欲望变化等
4. **固定事件执行器 (Event Resolver)**
   - 接收 `EventID + 玩家选择`
   - 产出数值变更、flags 变更、关系变更等

### 4.2 L4-B 派生约束器 (Constraints)

> **不修改 L2**，只回答“能不能/允许哪些选项”。

- 资源约束：`TP 是否足够`、`是否被拘束`、`是否沉默`
- 意志/失控约束：`Lust 是否超过阈值` → 是否允许“拒绝/逃跑/理智选项”
- 场景约束：`当前位置是否允许换装/休息/交易`

**[边界]**

- **【读】** L1, L2, Digest
- **【写】** 不直写 L2，只产出“变更集合”→交给 Apply

------

## 🧾 层级 4.5：派生摘要层 (Derived / Digest Layer)

> **性质**：摘要驱动的核心。把“真相”翻译成可判定、可展示、可喂给 LLM 的结构化摘要。
> **输入**：L1 + L2
> **输出**：Digest（只读）

### Digest 应包含的典型内容

- **环境摘要**：时段氛围、区域安全基底、可用设施
- **风险指标**：危险等级、遇敌权重、巡逻强度（由治安/时段/位置/残留等推导）
- **费洛蒙/暴露等派生量**：由衣物标签、破损、体液残留、状态阶段等推导
- **可触发事件池**：当前满足条件的事件ID集合（含权重）
- **选项限制摘要**：哪些行为被禁止/受限（供 UI 与叙事一致使用）
- **叙事用“关键句”素材**：用于快速拼装提示词的短句片段

**[边界]**

- **【读】** L1, L2
- **【写】** 禁止（Digest 本身不写回任何状态）

------

## 📝 层级 5：叙事与元系统 (L5 - Narration & Meta)

> **性质**：只读摘要与本回合结果，将其表达为文本，并进行长期评价/成就/剧情推进。
> **注意**：成就/评价/剧情推进若需要写入，也只能写入 **L2 的 Meta/Flags**，不得写 L1。

### 5.1 叙事提示词构建器 (Prompt Builder)

- **【读】** Digest + 本回合事件结果摘要（来自 L4）
- **【输出】** 给 LLM 的 Prompt（尽量短、结构化、可控）

### 5.2 剧情节点系统（简易）(Story Nodes)

- **【读】** L2.Flags + Digest（必要时）
- **【写】** 仅写入 L2.Flags（推进节点、开启/关闭事件池）

### 5.3 成就与称号监听 (Achievement & Title Watcher)

- **【读】** L2 的变化流（或回合结束后的 L2 快照）+ 定义表（L1）
- **【写】** L2.UnlockedAchievements、L2.Titles（或 L2.Meta 域）
- **逻辑**：满足条件 → 解锁成就/授予称号（只记录结果，不改定义表）

### 5.4 评价系统 (Evaluation)

- **【读】** L2（关键域）+ Digest
- **【写】** 可写入 L2 的评价记录（可选），或仅作为结算展示

------

## 🔄 调用流总览 (The Canonical Flow)

> 固定顺序，所有玩法都对齐这个顺序，避免“算两遍、顺序不一致”。

1. **[Input]** 玩家动作 / 剧情选择
2. **[Constraints]** L4-B 判断能否执行 & 可用选项
3. **[Resolve]** L4-A 执行动作 → 产出“变更集合 + 事件结果摘要”
4. **[Apply]** 统一写入通道把变更落入 L2（形成新真相）
5. **[Tick]** L3 自动演算（随时间推进）→ 产出变更集合
6. **[Apply]** 再次写入 L2
7. **[Digest]** 由 L1+L2 生成派生摘要（只读）
8. **[Meta/Narrate]** L5：剧情/成就/评价更新（写入 L2.Meta/Flags）+ 构建 Prompt → 生成文本输出

------

## ✅ 修订说明（相对 v2.0 的关键变化）

- “不得绕过 L4 修改 L2”修正为：**所有写入必须走统一写入通道（Apply）**，L3/L4 都可产出变更。
- 将 `CurrentPheromone/DangerLevel` 等从 L2 真相中剥离，统一归入 **Digest 派生摘要层**。
- 成就解锁不再写 L1，改为写入 **L2.Meta（UnlockedAchievements/Titles）**。
- 固定事件明确拆分：**触发（依赖 Digest）** 与 **执行（产出变更）**，避免叙事层越权改数值。

------

如果你想继续推进“世界书重构阶段”，下一步最有效的工作是：按 v2.1 的结构，把每个系统都补上同一套三行“边界声明”：

- **【读】** L1 哪些表 + L2 哪些域 + Digest 哪些字段
- **【写】** 只允许写入 L2 的哪些域（通过 Apply）
- **【输出摘要】** 对 Digest 贡献哪些派生字段（如果有）